version: 2.1

jobs:
  quality: &base-template
    description: Code style
    docker:
      - image: python:3
    environment:
      PIP_PREFER_BINARY: true
      PIP_PROGRESS_BAR: "off"
      TOXENV: style
    steps:
      - checkout
      - run: python -m pip install tox
      - run: tox

  tests-coverage:
    <<: *base-template
    description: Tests coverage - Python 3
    environment:
      TOXENV: tests-coverage
    steps:
      - checkout
      - run: python -m pip install tox codecov
      - run: tox
      - run: codecov

  tests314: &test-template
    <<: *base-template
    description: Tests - Python 3.14
    docker:
      - image: python:3.14
    environment:
      TOXENV: tests314
    steps:
      - checkout
      - run:
          name: Install OpenGL deps
          command: |
            apt-get update
            apt-get install -y --no-install-recommends \
              libgl1 libglx-mesa0 libgl1-mesa-dri libegl1-mesa-dev libgles2-mesa-dev libosmesa6 xvfb xauth
      - run: python -m pip install tox
      - run: xvfb-run -a tox

  tests310:
    <<: *test-template
    description: Tests - Python 3.10
    docker:
      - image: python:3.10
    environment:
      TOXENV: tests310

  tests311:
    <<: *test-template
    description: Tests - Python 3.11
    docker:
      - image: python:3.11
    environment:
      TOXENV: tests311

  tests312:
    <<: *test-template
    description: Tests - Python 3.12
    docker:
      - image: python:3.12
    environment:
      TOXENV: tests312

  tests313:
    <<: *test-template
    description: Tests - Python 3.13
    docker:
      - image: python:3.13
    environment:
      TOXENV: tests313

  tests315:
    <<: *test-template
    description: Tests - Python 3.15
    docker:
      - image: python:3.15-rc
    environment:
      TOXENV: tests315

  pypy311:
    <<: *test-template
    description: Tests - PyPy 3.11
    docker:
      - image: pypy:3.11
    environment:
      TOXENV: pypy311

workflows:
  version: 2
  build_and_test:
    jobs:
      - quality
      - tests-coverage:
          requires:
            - quality
      - tests314:
          requires:
            - quality
      - tests310:
          requires:
            - quality
      - tests311:
          requires:
            - quality
      - tests312:
          requires:
            - quality
      - tests313:
          requires:
            - quality
      - tests315:
          requires:
            - quality
      - pypy311:
          requires:
            - quality
